import { Task } from '../../models/task.js';
import mongoose from 'mongoose';

export const deleteTask = async (req, res, next) => {
  try {
    console.log('ğŸ—‘ï¸ Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ù…Ù‡Ù…Ø©...');
    console.log('ğŸ†” Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù‡Ù…Ø©:', req.params.id);
    console.log('ğŸ‘¤ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', req.user?._id);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (!req.user || !req.user._id) {
      return res.status(401).json({
        success: false,
        message: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'
      });
    }

    const { id } = req.params;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù‡Ù…Ø©
    if (!mongoose.Types.ObjectId.isValid(id)) {
      return res.status(400).json({
        success: false,
        message: 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù‡Ù…Ø© ØºÙŠØ± ØµØ­ÙŠØ­'
      });
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡Ø§ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    const task = await Task.findById(id);

    if (!task) {
      console.log('âŒ Ø§Ù„Ù…Ù‡Ù…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
      return res.status(404).json({
        success: false,
        message: 'Ø§Ù„Ù…Ù‡Ù…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'
      });
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    const canDelete = req.user._id.toString() === task.createdBy.toString() || 
                      req.user.role === 'admin';

    if (!canDelete) {
      console.log('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©');
      return res.status(403).json({
        success: false,
        message: 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©'
      });
    }

    // Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø³Ø¬Ù„Ø§Øª
    const taskInfo = {
      id: task._id,
      title: task.title,
      grade: task.grade,
      subject: task.subject,
      dueDate: task.dueDate,
      createdBy: task.createdBy,
      deletedBy: req.user._id,
      deletedAt: new Date()
    };

    console.log('ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', taskInfo);

    // Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
    await Task.findByIdAndDelete(id);

    console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­:', taskInfo.title);

    res.status(200).json({
      success: true,
      message: 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­',
      data: {
        deletedTask: {
          id: taskInfo.id,
          title: taskInfo.title,
          grade: taskInfo.grade,
          subject: taskInfo.subject
        },
        deletedAt: taskInfo.deletedAt,
        deletedBy: req.user.name || req.user.email
      }
    });

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©:', error);
    next(error);
  }
};